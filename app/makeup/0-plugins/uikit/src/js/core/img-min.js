import{createEvent,css,Dimensions,escape,getImage,includes,IntersectionObserver,isUndefined,noop,queryAll,startsWith,toFloat,toPx,trigger}from"uikit-util";export default{args:"dataSrc",props:{dataSrc:String,dataSrcset:Boolean,sizes:String,width:Number,height:Number,offsetTop:String,offsetLeft:String,target:String},data:{dataSrc:"",dataSrcset:!1,sizes:!1,width:!1,height:!1,offsetTop:"50vh",offsetLeft:0,target:!1},computed:{cacheKey({dataSrc:e}){return`${this.$name}.${e}`},width:({width:e,dataWidth:t})=>e||t,height:({height:e,dataHeight:t})=>e||t,sizes:({sizes:e,dataSizes:t})=>e||t,isImg:(e,t)=>isImg(t),target:{get({target:e}){return[this.$el].concat(queryAll(e,this.$el))},watch(){this.observe()}},offsetTop:({offsetTop:e})=>toPx(e,"height"),offsetLeft:({offsetLeft:e})=>toPx(e,"width")},connected(){storage[this.cacheKey]?setSrcAttrs(this.$el,storage[this.cacheKey]||this.dataSrc,this.dataSrcset,this.sizes):this.isImg&&this.width&&this.height&&setSrcAttrs(this.$el,getPlaceholderImage(this.width,this.height,this.sizes)),this.observer=new IntersectionObserver(this.load,{rootMargin:`${this.offsetTop}px ${this.offsetLeft}px`}),requestAnimationFrame(this.observe)},disconnected(){this.observer.disconnect()},update:{read({image:e}){if(e||"complete"!==document.readyState||this.load(this.observer.takeRecords()),this.isImg)return!1;e&&e.then(e=>e&&""!==e.currentSrc&&setSrcAttrs(this.$el,currentSrc(e)))},write(e){if(this.dataSrcset&&1!==window.devicePixelRatio){const t=css(this.$el,"backgroundSize");(t.match(/^(auto\s?)+$/)||toFloat(t)===e.bgSize)&&(e.bgSize=getSourceSize(this.dataSrcset,this.sizes),css(this.$el,"backgroundSize",`${e.bgSize}px`))}},events:["resize"]},methods:{load(e){e.some(e=>isUndefined(e.isIntersecting)||e.isIntersecting)&&(this._data.image=getImage(this.dataSrc,this.dataSrcset,this.sizes).then(e=>(setSrcAttrs(this.$el,currentSrc(e),e.srcset,e.sizes),storage[this.cacheKey]=currentSrc(e),e),noop),this.observer.disconnect())},observe(){!this._data.image&&this._connected&&this.target.forEach(e=>this.observer.observe(e))}}};function setSrcAttrs(e,t,s,i){if(isImg(e))i&&(e.sizes=i),s&&(e.srcset=s),t&&(e.src=t);else if(t){!includes(e.style.backgroundImage,t)&&(css(e,"backgroundImage",`url(${escape(t)})`),trigger(e,createEvent("load",!1)))}}function getPlaceholderImage(e,t,s){return s&&({width:e,height:t}=Dimensions.ratio({width:e,height:t},"width",toPx(sizesToPixel(s)))),`data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="${e}" height="${t}"></svg>`}const sizesRe=/\s*(.*?)\s*(\w+|calc\(.*?\))\s*(?:,|$)/g;function sizesToPixel(e){let t;for(sizesRe.lastIndex=0;t=sizesRe.exec(e);)if(!t[1]||window.matchMedia(t[1]).matches){t=evaluateSize(t[2]);break}return t||"100vw"}const sizeRe=/\d+(?:\w+|%)/g,additionRe=/[+-]?(\d+)/g;function evaluateSize(e){return startsWith(e,"calc")?e.substring(5,e.length-1).replace(sizeRe,e=>toPx(e)).replace(/ /g,"").match(additionRe).reduce((e,t)=>e+ +t,0):e}const srcSetRe=/\s+\d+w\s*(?:,|$)/g;function getSourceSize(e,t){const s=toPx(sizesToPixel(t)),i=(e.match(srcSetRe)||[]).map(toFloat).sort((e,t)=>e-t);return i.filter(e=>e>=s)[0]||i.pop()||""}function isImg(e){return"IMG"===e.tagName}function currentSrc(e){return e.currentSrc||e.src}const key="__test__";let storage;try{(storage=window.sessionStorage||{})[key]=1,delete storage[key]}catch(e){storage={}}