import{attr}from"./attr";import{once}from"./event";import{Promise}from"./promise";import{assign,includes,isString,noop,toNode}from"./lang";let id=0;export class Player{constructor(e){this.id=++id,this.el=toNode(e)}isVideo(){return this.isYoutube()||this.isVimeo()||this.isHTML5()}isHTML5(){return"VIDEO"===this.el.tagName}isIFrame(){return"IFRAME"===this.el.tagName}isYoutube(){return this.isIFrame()&&!!this.el.src.match(/\/\/.*?youtube(-nocookie)?\.[a-z]+\/(watch\?v=[^&\s]+|embed)|youtu\.be\/.*/)}isVimeo(){return this.isIFrame()&&!!this.el.src.match(/vimeo\.com\/video\/.*/)}enableApi(){if(this.ready)return this.ready;const e=this.isYoutube(),t=this.isVimeo();let i;return e||t?this.ready=new Promise(s=>{once(this.el,"load",()=>{if(e){const e=()=>post(this.el,{event:"listening",id:this.id});i=setInterval(e,100),e()}}),listen(i=>e&&i.id===this.id&&"onReady"===i.event||t&&Number(i.player_id)===this.id).then(()=>{s(),i&&clearInterval(i)}),attr(this.el,"src",`${this.el.src}${includes(this.el.src,"?")?"&":"?"}${e?"enablejsapi=1":`api=1&player_id=${this.id}`}`)}):Promise.resolve()}play(){if(this.isVideo())if(this.isIFrame())this.enableApi().then(()=>post(this.el,{func:"playVideo",method:"play"}));else if(this.isHTML5())try{const e=this.el.play();e&&e.catch(noop)}catch(e){}}pause(){this.isVideo()&&(this.isIFrame()?this.enableApi().then(()=>post(this.el,{func:"pauseVideo",method:"pause"})):this.isHTML5()&&this.el.pause())}mute(){this.isVideo()&&(this.isIFrame()?this.enableApi().then(()=>post(this.el,{func:"mute",method:"setVolume",value:0})):this.isHTML5()&&(this.el.muted=!0,attr(this.el,"muted","")))}}function post(e,t){try{e.contentWindow.postMessage(JSON.stringify(assign({event:"command"},t)),"*")}catch(e){}}function listen(e){return new Promise(t=>{once(window,"message",(e,i)=>t(i),!1,({data:t})=>{if(t&&isString(t)){try{t=JSON.parse(t)}catch(e){return}return t&&e(t)}})})}